//
//  electra_objc.m
//  electra1131
//
//  Created by CoolStar on 6/6/18.
//  Copyright Â© 2018 CoolStar. All rights reserved.
//

#include <dlfcn.h>
#include <copyfile.h>
#include <stdio.h>
#include <spawn.h>
#include <unistd.h>
#include <mach/mach.h>
#include <mach-o/dyld.h>
#include <sys/stat.h>
#include <sys/mount.h>
#include <sys/utsname.h>
#import <Foundation/Foundation.h>
#import "NSData+GZip.h"
#import "utils.h"
#import "file_utils.h"

#import "ViewController.h"

#include "electra_objc.h"
#include "MobileGestalt.h"
#include <CommonCrypto/CommonCrypto.h>
#include "NSString+SHA256.h"

const char* realPath() {
    char path[4096];
    uint32_t size = sizeof(path);
    _NSGetExecutablePath(path, &size);
    char *pt = realpath(path, NULL);
    return pt;
}

const char* progname(const char* prog) {
    NSString *execpath = [[NSString stringWithUTF8String:realPath()] stringByDeletingLastPathComponent];
    
    NSString *bootstrap = [execpath stringByAppendingPathComponent:[NSString stringWithUTF8String:prog]];
    return [bootstrap UTF8String];
}

const char *userGenerator(void) {
    NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
    if ([userDefaults objectForKey:@K_GENERATOR] == nil)
        return NULL;
    
    const char *generator = [[userDefaults objectForKey:@K_GENERATOR] UTF8String];
    char compareString[22];
    uint64_t rawGeneratorValue;
    sscanf(generator, "0x%16llx", &rawGeneratorValue);
    sprintf(compareString, "0x%016llx", rawGeneratorValue);
    if(strcmp(compareString, generator) != 0)
        return NULL;
    return generator;
}

const char *genToSet(void) {
    const char *generator = userGenerator();
    if (generator == NULL)
        generator = strdup(K_ELECTRA_GENERATOR);
    
    return generator;
}


void extractGz(const char *from, const char *to) {
    NSData *gz = [NSData dataWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@(from) ofType:@"gz"]];
    NSData *extracted = [gz gunzippedData];
    int fd = open(to, O_CREAT | O_WRONLY, 0755);
    write(fd, [extracted bytes], [extracted length]);
    close(fd);
}

void update_springboard_plist(){
    NSDictionary *springBoardPlist = [NSMutableDictionary dictionaryWithContentsOfFile:@"/var/mobile/Library/Preferences/com.apple.springboard.plist"];
    [springBoardPlist setValue:@YES forKey:@"SBShowNonDefaultSystemApps"];
    [springBoardPlist writeToFile:@"/var/mobile/Library/Preferences/com.apple.springboard.plist" atomically:YES];
    
    NSDictionary* attr = [NSDictionary dictionaryWithObjectsAndKeys:[NSNumber numberWithShort:0755], NSFilePosixPermissions,@"mobile",NSFileOwnerAccountName,NULL];
    
    NSError *error = nil;
    [[NSFileManager defaultManager] setAttributes:attr ofItemAtPath:@"/var/mobile/Library/Preferences/com.apple.springboard.plist" error:&error];
}

void startDaemons(){
    pid_t pd;
    NSArray *files = [[NSFileManager defaultManager] contentsOfDirectoryAtPath:@"/etc/rc.d" error:nil];
    for (NSString *fileName in files){
        NSString *fullPath = [@"/etc/rc.d" stringByAppendingPathComponent:fileName];
        run([fullPath UTF8String]);
    }
    
    files = [[NSFileManager defaultManager] contentsOfDirectoryAtPath:@"/Library/LaunchDaemons/" error:nil];
    for (NSString *fileName in files){
        if ([fileName isEqualToString:@"jailbreakd.plist"])
            continue;
        if ([fileName isEqualToString:@"com.openssh.sshd.plist"])
            continue;
        
        NSString *fullPath = [@"/Library/LaunchDaemons" stringByAppendingPathComponent:fileName];
        
        posix_spawn(&pd, "/bin/launchctl", NULL, NULL, (char **)&(const char*[]){ "launchctl", "load", [fullPath UTF8String], NULL }, NULL);
        waitpid(pd, NULL, 0);
    }
}

void dumpContentsOfDir(char *path){
    NSArray *files = [[NSFileManager defaultManager] contentsOfDirectoryAtPath:[NSString stringWithUTF8String:path] error:nil];
    NSLog(@"Files at %s: %@", path, files);
}

void dumpContentsOfFile(char *path){
    NSString *fileContents = [NSString stringWithContentsOfFile:[NSString stringWithUTF8String:path] encoding:NSUTF8StringEncoding error:nil];
    NSLog(@"File %s contains: %@", path, fileContents);
}


void newwaiting(){
    [[ViewController currentViewController] newwaiting];
}

void waitupdatespring(){
    [[ViewController currentViewController] waitupdatespring];
}
void waitfaketfp(){
    [[ViewController currentViewController] waitfaketfp];
}

void waittermkernel(){
    [[ViewController currentViewController] waittermkernel];
}

void almostdone(){
    [[ViewController currentViewController] almostdone];
}
void Vouchermessage(){
    [[ViewController currentViewController] Vouchermessage];
}
void runningpatches(){
    [[ViewController currentViewController] runningpatches];
}
void runningexploit(){
    [[ViewController currentViewController] runningexploit];
}
void runningexploitFinal(){
    [[ViewController currentViewController] runningexploitFinal];
}
void wait4jailbreakd(){
    [[ViewController currentViewController] wait4jailbreakd];
}

void rmounting(){
    [[ViewController currentViewController] rmounting];
}

void semiworkin(){
    [[ViewController currentViewController] semiworkin];
}   

void canaryPwait(){
    [[ViewController currentViewController] canaryPwait];
}
void canarySwait(){
    [[ViewController currentViewController] canarySwait];
}
void canarySLwait(){
    [[ViewController currentViewController] canarySLwait];
}

void serverS(){
    [[ViewController currentViewController] serverS];
}

void startdwait(){
    [[ViewController currentViewController] startdwait];
}
void displaySnapshotNotice(){
    [[ViewController currentViewController] displaySnapshotNotice];
}

void displaySnapshotWarning(){
    [[ViewController currentViewController] displaySnapshotWarning];
}

void removingLiberiOS(){
    [[ViewController currentViewController] removingLiberiOS];
}
void removingJailbreak(){
    [[ViewController currentViewController] removingJailbreak];
}
void removingJailbreaknotice(){
    [[ViewController currentViewController] removingJailbreaknotice];
}

void installingCydia(){
    [[ViewController currentViewController] installingCydia];
}

bool justCheckCyf0rc3(){
    
    if (newTFcheckofCyforce == 0) {
        printf("failed to cyforce test file\n");
    } else {
        int rv = open("/var/mobile/testCyforce.txt",O_RDWR|O_CREAT);
        printf("[*] Finally we can overcome the devils\n");
        printf("[*] wrote cyforce test file : %d\n", rv);
        close(rv);
        [[ViewController currentViewController] cyforceJailbreak];
    }
    return newTFcheckofCyforce;
}

bool checkingJUSTremovecheck(){
    
    if (newTFcheckMyRemover4me == 0) {
        
        printf("failed to write remover file\n");
    } else {
        int rv = open("/var/mobile/Media/.bootstrapped_electraremover",O_RDWR|O_CREAT);
        printf("[*] Don't Be Afraid Bad Dreams Are Only Dreams\n");
        printf("[*] wrote remover file : %d\n", rv);
        close(rv);
        [[ViewController currentViewController] removingJailbreak];
    }
    return newTFcheckMyRemover4me;
}


void JBremoverIsDone(){
    [[ViewController currentViewController] JBremoverIsDone];
}

void cydiaDone(){
    [[ViewController currentViewController] cydiaDone];
}

void restarting() {
    [[ViewController currentViewController] restarting];
}
