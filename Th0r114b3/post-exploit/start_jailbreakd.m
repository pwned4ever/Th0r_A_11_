//
//  jailbreakd.c
//  async_wake_ios
//
//  Created by CoolStar on 12/25/17.
//  Copyright Â© 2017 Electra Team. All rights reserved.
//

#import <sys/utsname.h>
#import <dlfcn.h>


#include <assert.h>
#include <mach/mach.h>
#include <stdlib.h>
#include <unistd.h>


#include <stdio.h>

#include <mach/error.h>
#include <mach/message.h>
#include <string.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <sys/stat.h>
#import <Foundation/Foundation.h>
#include "utils.h"
#include "utilities/file_utils.h"

int start_jailbreakd(uint64_t kernel_base) {
    unlink("/var/tmp/jailbreakd.pid");
    unlink("/var/run/jailbreakd.pid");
    unlink("/var/log/jailbreakd-stderr.log");
    unlink("/var/log/jailbreakd-stdout.log");
    
    NSData *blob = [NSData dataWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@"jailbreakd" ofType:@"plist"]];
    NSMutableDictionary *job = [NSPropertyListSerialization propertyListWithData:blob options:NSPropertyListMutableContainers format:nil error:nil];
    
    job[@"EnvironmentVariables"][@"KernelBase"] = [NSString stringWithFormat:@"0x%16llx", kernel_base];
    [job writeToFile:@"/Library/LaunchDaemons/jailbreakd.plist" atomically:YES];
    chmod("/Library/LaunchDaemons/jailbreakd.plist", 0644);
    chown("/Library/LaunchDaemons/jailbreakd.plist", 0, 0);
    
    pid_t pid = 0;
    usleep(10000);
    while (!file_exists("/bin/launchctl")){
        //printf("Waiting for jailbreakd...\n");
        //sleep(2); //100 ms
        usleep(100000);//10 ms
    }
    int rv = run("/bin/launchctl load /Library/LaunchDaemons/jailbreakd.plist");
    while (rv == -1){
        printf("Waiting for jailbreakd...\n");
        //sleep(2); //100 ms
        usleep(100000);//10 ms
    }
    if (rv == -1) {
        return -1;
    }
    
    int ex = 0;
   
    //NSLog(@"The dragon becomes me!");
    //NSLog(@"once it is drawn, it cannot be sheathed without causing death");
    usleep(100000);
    waitpid(pid, &ex, 0);
    return 0;
}
